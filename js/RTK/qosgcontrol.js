import {findNodeHandle, Platform, NativeModules} from 'react-native'
import {enable, Image as GImage, ReactNativeBridge} from 'gcanvas.js/src/index.js'

function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}
function _objectSpread(e){for(var t=1;t<arguments.length;t++){var o=null==arguments[t]?{}:arguments[t],n=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),n.forEach(function(t){_defineProperty(e,t,o[t])})}return e}
function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}

var RTKControl = (function() {

  Array.prototype.random=Array.prototype.random||function(){if(!this.length){return null}return this[Math.floor(RTK.RNG.getUniform()*this.length)]};Array.prototype.randomize=Array.prototype.randomize||function(){var result=[];var clone=this.slice();while(clone.length){var index=clone.indexOf(clone.random());result.push(clone.splice(index,1)[0])}return result};Function.prototype.extend=Function.prototype.extend||function(parent){this.prototype=Object.create(parent.prototype);this.prototype.constructor=this;return this};String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)};String.prototype.lpad=String.prototype.lpad||function(character,count){var ch=character||"0";var cnt=count||2;var s="";while(s.length<cnt-this.length){s+=ch}s=s.substring(0,cnt-this.length);return s+this};String.prototype.rpad=String.prototype.rpad||function(character,count){var ch=character||"0";var cnt=count||2;var s="";while(s.length<cnt-this.length){s+=ch}s=s.substring(0,cnt-this.length);return this+s};String.format=String.format||function(template){var map=String.format.map;var args=Array.prototype.slice.call(arguments,1);var replacer=function(match,group1,group2,index){if(template.charAt(index-1)=="%"){return match.substring(1)}if(!args.length){return match}var obj=args[0];var group=group1||group2;var parts=group.split(",");var name=parts.shift();var method=map[name.toLowerCase()];if(!method){return match}var obj=args.shift();var replaced=obj[method].apply(obj,parts);var first=name.charAt(0);if(first!=first.toLowerCase()){replaced=replaced.capitalize()}return replaced};return template.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,replacer)};String.format.map=String.format.map||{s:"toString"};String.prototype.format=String.prototype.format||function(){var args=Array.prototype.slice.call(arguments);args.unshift(this);return String.format.apply(String,args)};


  var RTK={_context:{},_data:{},_dirty:false,_options:{},DIRS:{"4":[[0,-1],[1,0],[0,1],[-1,0]],"8":[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],"6":[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]}};RTK.RTK_ASCII={TYPE_TEXT:0,TYPE_NEWLINE:1,TYPE_FG:2,TYPE_MG2:3,TYPE_MG1:4,TYPE_BG:5,_breakLines:function _breakLines(tokens,maxWidth){if(!maxWidth){console.log("err no maxWidth applied")}var i=0;var lineLength=0;var lastTokenWithSpace=-1;while(i<tokens.length){var token=tokens[i];if(token.type==RTK_ASCII.TYPE_NEWLINE){lineLength=0;lastTokenWithSpace=-1}if(token.type!=RTK_ASCII.TYPE_TEXT){i++;continue}while(lineLength==0&&token.value.charAt(0)==" "){token.value=token.value.substring(1)};var index=token.value.indexOf("\n");if(index!=-1){token.value=this._breakInsideToken(tokens,i,index,true);var arr=token.value.split("");while(arr.length&&arr[arr.length-1]==" "){arr.pop()}token.value=arr.join("")}if(!token.value.length){tokens.splice(i,1);continue}if(lineLength+token.value.length>maxWidth){var index=-1;while(1){var nextIndex=token.value.indexOf(" ",index+1);if(nextIndex==-1){break}if(lineLength+nextIndex>maxWidth){break}index=nextIndex}if(index!=-1){token.value=this._breakInsideToken(tokens,i,index,true)}else if(lastTokenWithSpace!=-1){var token=tokens[lastTokenWithSpace];var breakIndex=token.value.lastIndexOf(" ");token.value=this._breakInsideToken(tokens,lastTokenWithSpace,breakIndex,true);i=lastTokenWithSpace}else{token.value=this._breakInsideToken(tokens,i,maxWidth-lineLength,false)}}else{lineLength+=token.value.length;if(token.value.indexOf(" ")!=-1){lastTokenWithSpace=i}}i++}tokens.push({type:RTK_ASCII.TYPE_NEWLINE});var lastTextToken=null;for(var i=0;i<tokens.length;i++){var token=tokens[i];switch(token.type){case RTK_ASCII.TYPE_TEXT:lastTextToken=token;break;case RTK_ASCII.TYPE_NEWLINE:if(lastTextToken){var arr=lastTextToken.value.split("");while(arr.length&&arr[arr.length-1]==" "){arr.pop()}lastTextToken.value=arr.join("")}lastTextToken=null;break;}}tokens.pop();return tokens},measure:function measure(str,maxWidth){var result={width:0,height:1};var tokens=this.tokenize(str,maxWidth);var lineWidth=0;for(var i=0;i<tokens.length;i++){var token=tokens[i];switch(token.type){case this.TYPE_TEXT:lineWidth+=token.value.length;break;case this.TYPE_NEWLINE:result.height++;result.width=Math.max(result.width,lineWidth);lineWidth=0;break;}}result.width=Math.max(result.width,lineWidth);return result},tokenize:function tokenize(str,maxWidth){var result=[];var offset=0;str.replace(this.ASCII_COLORS,function(match,type,name,index){var part=str.substring(offset,index);if(part.length){result.push({type:RTK_ASCII.TYPE_TEXT,value:part})};result.push({type:type=="c"?RTK_ASCII.TYPE_FG:RTK_ASCII.TYPE_BG,value:name.trim()});offset=index+match.length;return""});var part=str.substring(offset);if(part.length){result.push({type:RTK_ASCII.TYPE_TEXT,value:part})};return this._breakLines(result,maxWidth)},_breakInsideToken:function _breakInsideToken(tokens,tokenIndex,breakIndex,removeBreakChar){var newBreakToken={type:RTK_ASCII.TYPE_NEWLINE};var newTextToken={type:RTK_ASCII.TYPE_TEXT,value:tokens[tokenIndex].value.substring(breakIndex+(removeBreakChar?1:0))};tokens.splice(tokenIndex+1,0,newBreakToken,newTextToken);return tokens[tokenIndex].value.substring(0,breakIndex)}};RTK.Color={_clamp:function _clamp(num){if(num<0){return 0}else if(num>255){return 255}else{return num}},fromString:function fromString(str){var cached,r;if(str in this._cache){cached=this._cache[str]}else{if(str.charAt(0)=="#"){var values=str.match(/[0-9a-f]/gi).map(function(x){return parseInt(x,16)});if(values.length==3){cached=values.map(function(x){return x*17})}else{for(var i=0;i<3;i++){values[i+1]+=16*values[i];values.splice(i,1)}cached=values}}else if(r=str.match(/rgb\(([0-9, ]+)\)/i)){cached=r[1].split(/\s*,\s*/).map(function(x){return parseInt(x)})}else{cached=[0,0,0]}this._cache[str]=cached}return cached.slice()},add:function add(color1,color2){var result=color1.slice();for(var i=0;i<3;i++){for(var j=1;j<arguments.length;j++){result[i]+=arguments[j][i]}}return result},multiply:function multiply(color1,color2){var result=color1.slice();for(var i=0;i<3;i++){for(var j=1;j<arguments.length;j++){result[i]*=arguments[j][i]/255}result[i]=Math.round(result[i])}return result},multiply_:function multiply_(color1,color2){for(var i=0;i<3;i++){for(var j=1;j<arguments.length;j++){color1[i]*=arguments[j][i]/255}color1[i]=Math.round(color1[i])}return color1},interpolate:function interpolate(color1,color2,factor){if(arguments.length<3){factor=0.5};var result=color1.slice();for(var i=0;i<3;i++){result[i]=Math.round(result[i]+factor*(color2[i]-color1[i]))}return result},toRGB:function toRGB(color){return"rgb("+Color._clamp(color[0])+","+Color._clamp(color[1])+","+Color._clamp(color[2])+")"},toHex:function toHex(color){var parts=[];for(var i=0;i<3;i++){parts.push(this._clamp(color[i]).toString(16).lpad("0",2))}return"#"+parts.join("")}};RTK.Engine=function(scheduler){this._scheduler=scheduler;this._lock=1};RTK.Engine.prototype.start=function(){return this.unlock()};RTK.Engine.prototype.lock=function(){this._lock++;return this};RTK.Engine.prototype.unlock=function(){if(!this._lock){throw new Error("Cannot unlock unlocked engine")}this._lock--;while(!this._lock){var actor=this._scheduler.next();if(!actor){return this.lock()}var result=actor.act();if(result&&result.then){this.lock();result.then(this.unlock.bind(this))}}return this};RTK.EventQueue=function(){this._time=0;this._events=[];this._eventTimes=[]};RTK.EventQueue.prototype.getTime=function(){return this._time};RTK.EventQueue.prototype.clear=function(){this._events=[];this._eventTimes=[];return this};RTK.EventQueue.prototype.add=function(event,time){var index=this._events.length;for(var i=0;i<this._eventTimes.length;i++){if(this._eventTimes[i]>time){index=i;break}}this._events.splice(index,0,event);this._eventTimes.splice(index,0,time)};RTK.EventQueue.prototype.get=function(){if(!this._events.length){return null}var time=this._eventTimes.splice(0,1)[0];if(time>0){this._time+=time;for(var i=0;i<this._eventTimes.length;i++){this._eventTimes[i]-=time}}return this._events.splice(0,1)[0]};RTK.EventQueue.prototype.getEventTime=function(event){var index=this._events.indexOf(event);if(index==-1){return undefined}return this._eventTimes[index]};RTK.EventQueue.prototype.remove=function(event){var index=this._events.indexOf(event);if(index==-1){return false}this._remove(index);return true};RTK.EventQueue.prototype._remove=function(index){this._events.splice(index,1);this._eventTimes.splice(index,1)};RTK.FOV=function(lightPassesCallback,options){this._lightPasses=lightPassesCallback;this._options={topology:8};for(var p in options){this._options[p]=options[p]}};RTK.FOV.prototype.compute=function(x,y,R,callback){};RTK.FOV.prototype._getCircle=function(cx,cy,r){var result=[];var dirs,countFactor,startOffset;switch(this._options.topology){case 4:countFactor=1;startOffset=[0,1];dirs=[RTK.DIRS[8][7],RTK.DIRS[8][1],RTK.DIRS[8][3],RTK.DIRS[8][5]];break;case 6:dirs=RTK.DIRS[6];countFactor=1;startOffset=[-1,1];break;case 8:dirs=RTK.DIRS[4];countFactor=2;startOffset=[-1,1];break;}var x=cx+startOffset[0]*r;var y=cy+startOffset[1]*r;for(var i=0;i<dirs.length;i++){for(var j=0;j<r*countFactor;j++){result.push([x,y]);x+=dirs[i][0];y+=dirs[i][1]}}return result};RTK.RNG={getSeed:function getSeed(){return this._seed},setSeed:function setSeed(seed){seed=seed<1?1/seed:seed;this._seed=seed;this._s0=(seed>>>0)*this._frac;seed=seed*69069+1>>>0;this._s1=seed*this._frac;seed=seed*69069+1>>>0;this._s2=seed*this._frac;this._c=1;return this},getUniform:function getUniform(){var t=2091639*this._s0+this._c*this._frac;this._s0=this._s1;this._s1=this._s2;this._c=t|0;this._s2=t-this._c;return this._s2},getUniformInt:function getUniformInt(lowerBound,upperBound){var max=Math.max(lowerBound,upperBound);var min=Math.min(lowerBound,upperBound);return Math.floor(this.getUniform()*(max-min+1))+min},getNormal:function getNormal(mean,stddev){do{var u=2*this.getUniform()-1;var v=2*this.getUniform()-1;var r=u*u+v*v}while(r>1||r==0);var gauss=u*Math.sqrt(-2*Math.log(r)/r);return(mean||0)+gauss*(stddev||1)},getPercentage:function getPercentage(){return 1+Math.floor(this.getUniform()*100)},getWeightedValue:function getWeightedValue(data){var total=0;for(var id in data){total+=data[id]}var random=this.getUniform()*total;var part=0;for(var id in data){part+=data[id];if(random<part){return id}}return id},getState:function getState(){return[this._s0,this._s1,this._s2,this._c]},setState:function setState(state){this._s0=state[0];this._s1=state[1];this._s2=state[2];this._c=state[3];return this},clone:function clone(){var clone=Object.create(this);clone.setState(this.getState());return clone},_s0:0,_s1:0,_s2:0,_c:0,_frac:2.3283064365386963e-10};RTK.RNG.setSeed(Date.now()); RTK.Display=function(options){var ref=options.refName;this.canvas_tag_nodeHandle=findNodeHandle(options.refName);var el={ref:""+this.canvas_tag_nodeHandle,style:{width:options.width,height:options.height}};this.refBridge=enable(el,{bridge:ReactNativeBridge});this._context=this.refBridge.getContext("2d");this._context.canvas={width:ref.width,height:ref.height};this._context.fillText("Hello World!@#$%^&*()_+-=",10,50);this._backend=null;this._data={};this._dirty=false;this._options={};this.defaultOptions={width:120,height:120,transpose:false,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:false,fontFamily:"monospace",fontStyle:"",fg:"#fff",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:false,termColor:"xterm"};this.defaultOptions=_objectSpread({},this.defaultOptions,options);this.setOptions=this.setOptions.bind(this);this._tick=this._tick.bind(this);this.setOptions(this.defaultOptions);requestAnimationFrame(this._tick)};RTK.Display.prototype.clear=function(){this._data={};this._dirty=true};RTK.Display.prototype.getContainer=function(){return this._context};RTK.Display.prototype.getNodeHandle=function(){return this.canvas_tag_nodeHandle};RTK.Display.prototype.getRefBridge=function(){return this.refBridge};RTK.Display.Backend=function(context){this._context=context};RTK.Display.Backend.prototype.compute=function(options){};RTK.Display.Backend.prototype.draw=function(data,clearBefore){};RTK.Display.Backend.prototype.computeSize=function(availWidth,availHeight){};RTK.Display.Backend.prototype.computeFontSize=function(availWidth,availHeight){};RTK.Display.Backend.prototype.eventToPosition=function(x,y){};RTK.Display.Rect=function(context){RTK.Display.Backend.call(this,context);this._spacingX=0;this._spacingY=0;this._canvasCache={};this._options={}};RTK.Display.Rect.extend(RTK.Display.Backend);RTK.Display.Rect.cache=false;RTK.Display.Rect.prototype.compute=function(options){this._canvasCache={};this._options=options;var charWidth=1;this._spacingX=Math.ceil(options.spacing*charWidth);this._spacingY=Math.ceil(options.spacing*options.fontSize);if(this._options.forceSquareRatio){this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)}this._context.canvas.width=options.width*this._spacingX;this._context.canvas.height=options.height*this._spacingY};RTK.Display.Rect.prototype.draw=function(data,clearBefore){if(this.constructor.cache){this._drawWithCache(data,clearBefore)}else{this._drawNoCache(data,clearBefore)}};RTK.Display.Rect.prototype._drawWithCache=function(data,clearBefore){var x=data[0];var y=data[1];var ch=data[2];var fg=data[3];var bg=data[4];var hash=""+ch+fg+bg;if(hash in this._canvasCache){var canvas=this._canvasCache[hash]}else{var b=this._options.border;var canvas=document.createElement("canvas");var ctx=canvas.getContext("2d");canvas.width=this._spacingX;canvas.height=this._spacingY;ctx.fillStyle=bg;ctx.fillRect(b,b,canvas.width-b,canvas.height-b);if(ch){ctx.fillStyle=fg;ctx.font=this._context.font;ctx.textAlign="center";ctx.textBaseline="middle";var chars=[].concat(ch);for(var i=0;i<chars.length;i++){ctx.fillText(chars[i],this._spacingX/2,Math.ceil(this._spacingY/2))}}this._canvasCache[hash]=canvas}this._context.drawImage(canvas,x*this._spacingX,y*this._spacingY)};RTK.Display.Rect.prototype._drawNoCache=function(data,clearBefore){var x=data[0];var y=data[1];var ch=data[2];var fg=data[3];var bg=data[4];if(clearBefore){var b=this._options.border;this._context.fillStyle=bg;this._context.fillRect(x*this._spacingX+b,y*this._spacingY+b,this._spacingX-b,this._spacingY-b)}if(!ch){return}this._context.fillStyle=fg;var chars=[].concat(ch);for(var i=0;i<chars.length;i++){this._context.fillText(chars[i],(x+0.5)*this._spacingX,Math.ceil((y+0.5)*this._spacingY))}};RTK.Display.Rect.prototype.computeSize=function(availWidth,availHeight){var width=Math.floor(availWidth/this._spacingX);var height=Math.floor(availHeight/this._spacingY);return[width,height]};RTK.Display.Rect.prototype.computeFontSize=function(availWidth,availHeight){var boxWidth=Math.floor(availWidth/this._options.width);var boxHeight=Math.floor(availHeight/this._options.height);var oldFont=this._context.font;this._context.font="100px "+this._options.fontFamily;var width=1;this._context.font=oldFont;var ratio=width/100;var widthFraction=ratio*boxHeight/boxWidth;if(widthFraction>1){boxHeight=Math.floor(boxHeight/widthFraction)}return Math.floor(boxHeight/this._options.spacing)};RTK.Display.Rect.prototype.eventToPosition=function(x,y){return[Math.floor(x/this._spacingX),Math.floor(y/this._spacingY)]};RTK.FOV.DiscreteShadowcasting=function(lightPassesCallback,options){RTK.FOV.call(this,lightPassesCallback,options)};RTK.FOV.DiscreteShadowcasting.extend(RTK.FOV);RTK.FOV.DiscreteShadowcasting.prototype.compute=function(x,y,R,callback){var center=this._coords;var map=this._map;callback(x,y,0,1);if(!this._lightPasses(x,y)){return}var DATA=[];var A,B,cx,cy,blocks;for(var r=1;r<=R;r++){var neighbors=this._getCircle(x,y,r);var angle=360/neighbors.length;for(var i=0;i<neighbors.length;i++){cx=neighbors[i][0];cy=neighbors[i][1];A=angle*(i-0.5);B=A+angle;blocks=!this._lightPasses(cx,cy);if(this._visibleCoords(Math.floor(A),Math.ceil(B),blocks,DATA)){callback(cx,cy,r,1)}if(DATA.length==2&&DATA[0]==0&&DATA[1]==360){return}}}};RTK.FOV.DiscreteShadowcasting.prototype._visibleCoords=function(A,B,blocks,DATA){if(A<0){var v1=this._visibleCoords(0,B,blocks,DATA);var v2=this._visibleCoords(360+A,360,blocks,DATA);return v1||v2}var index=0;while(index<DATA.length&&DATA[index]<A){index++}if(index==DATA.length){if(blocks){DATA.push(A,B)}return true}var count=0;if(index%2){while(index<DATA.length&&DATA[index]<B){index++;count++}if(count==0){return false}if(blocks){if(count%2){DATA.splice(index-count,count,B)}else{DATA.splice(index-count,count)}}return true}else{while(index<DATA.length&&DATA[index]<B){index++;count++}if(A==DATA[index-count]&&count==1){return false}if(blocks){if(count%2){DATA.splice(index-count,count,A)}else{DATA.splice(index-count,count,A,B)}}return true}};Array.prototype.random=Array.prototype.random||function(){if(!this.length){return null}return this[Math.floor(RTK.RNG.getUniform()*this.length)]};Array.prototype.randomize=Array.prototype.randomize||function(){var result=[];var clone=this.slice();while(clone.length){var index=clone.indexOf(clone.random());result.push(clone.splice(index,1)[0])}return result};Function.prototype.extend=Function.prototype.extend||function(parent){this.prototype=Object.create(parent.prototype);this.prototype.constructor=this;return this};String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)};String.prototype.lpad=String.prototype.lpad||function(character,count){var ch=character||"0";var cnt=count||2;var s="";while(s.length<cnt-this.length){s+=ch}s=s.substring(0,cnt-this.length);return s+this};String.prototype.rpad=String.prototype.rpad||function(character,count){var ch=character||"0";var cnt=count||2;var s="";while(s.length<cnt-this.length){s+=ch}s=s.substring(0,cnt-this.length);return this+s};String.format=String.format||function(template){var map=String.format.map;var args=Array.prototype.slice.call(arguments,1);var replacer=function replacer(match,group1,group2,index){if(template.charAt(index-1)=="%"){return match.substring(1)}if(!args.length){return match}var obj=args[0];var group=group1||group2;var parts=group.split(",");var name=parts.shift();var method=map[name.toLowerCase()];if(!method){return match}var obj=args.shift();var replaced=obj[method].apply(obj,parts);var first=name.charAt(0);if(first!=first.toLowerCase()){replaced=replaced.capitalize()}return replaced};return template.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,replacer)};String.format.map=String.format.map||{"s":"toString"};String.prototype.format=String.prototype.format||function(){var args=Array.prototype.slice.call(arguments);args.unshift(this);return String.format.apply(String,args)};RTK.Map=function(width,height){this._width=width||RTK.DEFAULT_WIDTH;this._height=height||RTK.DEFAULT_HEIGHT};RTK.Map.prototype.create=function(callback){};RTK.Map.prototype._fillMap=function(value){var map=[];for(var i=0;i<this._width;i++){map.push([]);for(var j=0;j<this._height;j++){map[i].push(value)}}return map};RTK.Map.Cellular=function(width,height,options){RTK.Map.call(this,width,height);this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8};this.setOptions(options);this._dirs=RTK.DIRS[this._options.topology];this._map=this._fillMap(0)};RTK.Map.Cellular.extend(RTK.Map);RTK.Map.Cellular.prototype.randomize=function(probability){for(var i=0;i<this._width;i++){for(var j=0;j<this._height;j++){this._map[i][j]=RTK.RNG.getUniform()<probability?1:0}}return this};RTK.Map.Cellular.prototype.setOptions=function(options){for(var p in options){this._options[p]=options[p]}};RTK.Map.Cellular.prototype.set=function(x,y,value){this._map[x][y]=value};RTK.Map.Cellular.prototype.create=function(callback){var newMap=this._fillMap(0);var born=this._options.born;var survive=this._options.survive;for(var j=0;j<this._height;j++){var widthStep=1;var widthStart=0;if(this._options.topology==6){widthStep=2;widthStart=j%2}for(var i=widthStart;i<this._width;i+=widthStep){var cur=this._map[i][j];var ncount=this._getNeighbors(i,j);if(cur&&survive.indexOf(ncount)!=-1){newMap[i][j]=1}else if(!cur&&born.indexOf(ncount)!=-1){newMap[i][j]=1}}}this._map=newMap;callback&&this._serviceCallback(callback)};RTK.Map.Cellular.prototype._serviceCallback=function(callback){for(var j=0;j<this._height;j++){var widthStep=1;var widthStart=0;if(this._options.topology==6){widthStep=2;widthStart=j%2}for(var i=widthStart;i<this._width;i+=widthStep){callback(i,j,this._map[i][j])}}};RTK.Map.Cellular.prototype._getNeighbors=function(cx,cy){var result=0;for(var i=0;i<this._dirs.length;i++){var dir=this._dirs[i];var x=cx+dir[0];var y=cy+dir[1];if(x<0||x>=this._width||y<0||y>=this._height){continue}result+=this._map[x][y]==1?1:0}return result};RTK.Map.Cellular.prototype._getClosest=function(point,space){var minPoint=null;var minDist=null;for(k in space){var p=space[k];var d=(p[0]-point[0])*(p[0]-point[0])+(p[1]-point[1])*(p[1]-point[1]);if(minDist==null||d<minDist){minDist=d;minPoint=p}}return minPoint};RTK.Map.Cellular.prototype._findConnected=function(connected,notConnected,stack,keepNotConnected,value){while(stack.length>0){var p=stack.splice(0,1)[0];var tests;if(this._options.topology==6){tests=[[p[0]+2,p[1]],[p[0]+1,p[1]-1],[p[0]-1,p[1]-1],[p[0]-2,p[1]],[p[0]-1,p[1]+1],[p[0]+1,p[1]+1]]}else{tests=[[p[0]+1,p[1]],[p[0]-1,p[1]],[p[0],p[1]+1],[p[0],p[1]-1]]}for(var i=0;i<tests.length;i++){var key=this._pointKey(tests[i]);if(connected[key]==null&&this._freeSpace(tests[i][0],tests[i][1],value)){connected[key]=tests[i];if(!keepNotConnected){delete notConnected[key]}stack.push(tests[i])}}}};RTK.Map.Cellular.prototype._tunnelToConnected=function(to,from,connected,notConnected,value,connectionCallback){var key=this._pointKey(from);var a,b;if(from[0]<to[0]){a=from;b=to}else{a=to;b=from}for(var xx=a[0];xx<=b[0];xx++){this._map[xx][a[1]]=value;var p=[xx,a[1]];var pkey=this._pointKey(p);connected[pkey]=p;delete notConnected[pkey]}if(connectionCallback&&a[0]<b[0]){connectionCallback(a,[b[0],a[1]])}var x=b[0];if(from[1]<to[1]){a=from;b=to}else{a=to;b=from}for(var yy=a[1];yy<b[1];yy++){this._map[x][yy]=value;var p=[x,yy];var pkey=this._pointKey(p);connected[pkey]=p;delete notConnected[pkey]}if(connectionCallback&&a[1]<b[1]){connectionCallback([b[0],a[1]],[b[0],b[1]])}};RTK.Map.Cellular.prototype._tunnelToConnected6=function(to,from,connected,notConnected,value,connectionCallback){var a,b;if(from[0]<to[0]){a=from;b=to}else{a=to;b=from}var xx=a[0];var yy=a[1];while(!(xx==b[0]&&yy==b[1])){var stepWidth=2;if(yy<b[1]){yy++;stepWidth=1}else if(yy>b[1]){yy--;stepWidth=1}if(xx<b[0]){xx+=stepWidth}else if(xx>b[0]){xx-=stepWidth}else if(b[1]%2){xx-=stepWidth}else{xx+=stepWidth}this._map[xx][yy]=value;var p=[xx,yy];var pkey=this._pointKey(p);connected[pkey]=p;delete notConnected[pkey]}if(connectionCallback){connectionCallback(from,to)}};RTK.Map.Cellular.prototype._freeSpace=function(x,y,value){return x>=0&&x<this._width&&y>=0&&y<this._height&&this._map[x][y]==value};RTK.Map.Cellular.prototype._pointKey=function(p){return p[0]+"."+p[1]};RTK.Map.Cellular.prototype.connect=function(callback,value,connectionCallback){if(!value)value=0;var allFreeSpace=[];var notConnected={};var widthStep=1;var widthStarts=[0,0];if(this._options.topology==6){widthStep=2;widthStarts=[0,1]}for(var y=0;y<this._height;y++){for(var x=widthStarts[y%2];x<this._width;x+=widthStep){if(this._freeSpace(x,y,value)){var p=[x,y];notConnected[this._pointKey(p)]=p;allFreeSpace.push([x,y])}}}var start=allFreeSpace[RTK.RNG.getUniformInt(0,allFreeSpace.length-1)];var key=this._pointKey(start);var connected={};connected[key]=start;delete notConnected[key];this._findConnected(connected,notConnected,[start],false,value);while(Object.keys(notConnected).length>0){var p=this._getFromTo(connected,notConnected);var from=p[0];var to=p[1];var local={};local[this._pointKey(from)]=from;this._findConnected(local,notConnected,[from],true,value);var tunnelFn=this._options.topology==6?this._tunnelToConnected6:this._tunnelToConnected;tunnelFn.call(this,to,from,connected,notConnected,value,connectionCallback);for(var k in local){var pp=local[k];this._map[pp[0]][pp[1]]=value;connected[k]=pp;delete notConnected[k]}}callback&&this._serviceCallback(callback)};RTK.Map.Cellular.prototype._getFromTo=function(connected,notConnected){var from,to,d;var connectedKeys=Object.keys(connected);var notConnectedKeys=Object.keys(notConnected);for(var i=0;i<5;i++){if(connectedKeys.length<notConnectedKeys.length){var keys=connectedKeys;to=connected[keys[RTK.RNG.getUniformInt(0,keys.length-1)]];from=this._getClosest(to,notConnected)}else{var keys=notConnectedKeys;from=notConnected[keys[RTK.RNG.getUniformInt(0,keys.length-1)]];to=this._getClosest(from,connected)}d=(from[0]-to[0])*(from[0]-to[0])+(from[1]-to[1])*(from[1]-to[1]);if(d<64){break}}return[from,to]};RTK.Display.prototype._draw=function(key,clearBefore){var data=this._data[key];if(data[4]!=this._options.bg){clearBefore=true};this._backend.draw(data,clearBefore)};RTK.Display.prototype.setOptions=function(options){for(var p in options){this._options[p]=options[p]};if(options.width||options.height||options.fontSize||options.fontFamily||options.spacing||options.layout){if(options.layout){this._backend=new RTK.Display.Rect(this._context)}var font=(this._options.fontStyle?this._options.fontStyle+" ":"")+this._options.fontSize+"px "+this._options.fontFamily;this._context.font=font;this._backend.compute(this._options);this._context.font=font;this._context.textAlign="center";this._context.textBaseline="middle";this._dirty=true}return this};RTK.Display.prototype.draw=function(x,y,ch,fg,bg){if(!fg){fg=this._options.fg}if(!bg){bg=this._options.bg}this._data[x+","+y]=[x,y,ch,fg,bg];if(this._dirty===true){return}if(!this._dirty){this._dirty={}}this._dirty[x+","+y]=true};RTK.Display.prototype.drawText=function(x,y,text,maxWidth){var fg=null;var bg=null;var cx=x;var cy=y;var lines=1;if(!maxWidth){maxWidth=this._options.width-x};var tokens=RTK_ASCII.tokenize(text,maxWidth);while(tokens.length){var token=tokens.shift();switch(token.type){case RTK_ASCII.TYPE_TEXT:var isSpace=false,isPrevSpace=false,isFullWidth=false,isPrevFullWidth=false;for(var i=0;i<token.value.length;i++){var cc=token.value.charCodeAt(i);var c=token.value.charAt(i);isFullWidth=cc>65280&&cc<65377||cc>65500&&cc<65512||cc>65518;isSpace=c.charCodeAt(0)==32||c.charCodeAt(0)==12288;if(isPrevFullWidth&&!isFullWidth&&!isSpace){cx++}if(isFullWidth&&!isPrevSpace){cx++}this.draw(cx++,cy,c,fg,bg);isPrevSpace=isSpace;isPrevFullWidth=isFullWidth}break;case RTK_ASCII.TYPE_FG:fg=token.value||null;break;case RTK_ASCII.TYPE_BG:bg=token.value||null;break;case RTK_ASCII.TYPE_NEWLINE:cx=x;cy++;lines++;break;}}return lines};RTK.Display.prototype._tick=function(){if(!this._dirty){console.log("_tick !this._dirty ");return}if(this._dirty===true){this._context.fillStyle=this._options.bg;this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height);for(var id in this._data){this._draw(id,false)}}else{for(var key in this._dirty){this._draw(key,true)}}this._dirty=false};RTK.Display.prototype._drawNoCache=function(data,clearBefore){var x=data[0];var y=data[1];var ch=data[2];var fg=data[3];var bg=data[4];if(clearBefore){var b=this._options.border;this._context.fillStyle=bg;this._context.fillRect(x*this._spacingX+b,y*this._spacingY+b,this._spacingX-b,this._spacingY-b)}if(!ch){return}this._context.fillStyle=fg;var chars=[].concat(ch);for(var i=0;i<chars.length;i++){this._context.fillText(chars[i],(x+0.5)*this._spacingX,Math.ceil((y+0.5)*this._spacingY))}};RTK.Scheduler=function(){this._queue=new RTK.EventQueue;this._repeat=[];this._current=null};RTK.Scheduler.prototype.getTime=function(){return this._queue.getTime()};RTK.Scheduler.prototype.add=function(item,repeat){if(repeat){this._repeat.push(item)}return this};RTK.Scheduler.prototype.getTimeOf=function(item){return this._queue.getEventTime(item)};RTK.Scheduler.prototype.clear=function(){this._queue.clear();this._repeat=[];this._current=null;return this};RTK.Scheduler.prototype.remove=function(item){var result=this._queue.remove(item);var index=this._repeat.indexOf(item);if(index!=-1){this._repeat.splice(index,1)}if(this._current==item){this._current=null}return result};RTK.Scheduler.prototype.next=function(){this._current=this._queue.get();return this._current};RTK.Scheduler.Speed=function(){RTK.Scheduler.call(this)};RTK.Scheduler.Speed.extend(RTK.Scheduler);RTK.Scheduler.Speed.prototype.add=function(item,repeat,time){this._queue.add(item,time!==undefined?time:1/item.getSpeed());return RTK.Scheduler.prototype.add.call(this,item,repeat)};RTK.Scheduler.Speed.prototype.next=function(){if(this._current&&this._repeat.indexOf(this._current)!=-1){this._queue.add(this._current,1/this._current.getSpeed())}return RTK.Scheduler.prototype.next.call(this)};

  return RTK
})

var QOSGControl = function(RTK) {

  var QOSG={_display:null,_currentScreen:null,_screenWidth:140,_screenHeight:14,init:function init(refName){this._display=new RTK.Display({width:this._screenWidth,height:this._screenHeight+1,refName:refName});this.nodeHandle=this._display.getNodeHandle();this.refBridge=this._display.getRefBridge();return this},getDisplay:function getDisplay(){return this._display},getScreenWidth:function getScreenWidth(){return this._screenWidth},getScreenHeight:function getScreenHeight(){return this._screenHeight},getContext:function getContext(){return this._display._context},getNodeHandle:function getNodeHandle(){return this.nodeHandle},getRefBridge:function getRefBridge(){return this.refBridge},refresh:function refresh(){this._display.clear();this._currentScreen.render(this._display)},switchScreen:function switchScreen(screen){if(this._currentScreen!==null){this._currentScreen.exit()}this.getDisplay().clear();this._currentScreen=screen;if(!this._currentScreen!==null){this._currentScreen.enter();this.refresh()}},renderCanvasFactory:function renderCanvasFactory(tileMap){var correctScope=this._display.getContainer();var stringmap=tileMap.map(function(textRow){return textRow.map(function(item){return item._char})});stringmap.map(function(textRow,i){return textRow.map(function(textInstance,j){return correctScope.fillText(textInstance,10*i,10)})})}};QOSG.Map=function(tiles){this._tiles=tiles;this._depth=tiles.length;this._width=tiles[0].length;this._height=tiles[0][0].length;this._fov=[];this.setupFov();this._entities={};this._scheduler=new RTK.Scheduler.Speed;this._engine=new RTK.Engine(this._scheduler);this._explored=new Array(this._depth);this._setupExploredArray();};QOSG.Map.prototype._setupExploredArray=function(){for(var z=0;z<this._depth;z++){this._explored[z]=new Array(this._width);for(var x=0;x<this._width;x++){this._explored[z][x]=new Array(this._height);for(var y=0;y<this._height;y++){this._explored[z][x][y]=false}}}};QOSG.Map.prototype.addEntity=function(entity){entity.setMap(this);this.updateEntityPosition(entity);if(entity.hasMixin("Actor")){this._scheduler.add(entity,true)}if(entity.hasMixin(QOSG.EntityMixins.PlayerActor)){this._player=entity}};QOSG.Map.prototype.getDepth=function(){return this._depth};QOSG.Map.prototype.getWidth=function(){return this._width};QOSG.Map.prototype.getHeight=function(){return this._height};QOSG.Map.prototype.getTile=function(x,y,z){if(x<0||x>=this._width||y<0||y>=this._height||z<0||z>=this._depth){return QOSG.Tile.nullTile}else{return this._tiles[z][x][y]||QOSG.Tile.nullTile}};QOSG.Map.prototype.dig=function(x,y,z){if(this.getTile(x,y,z).isDiggable()){this._tiles[z][x][y]=QOSG.Tile.floorTile}};QOSG.Map.prototype.isEmptyFloor=function(x,y,z){return this.getTile(x,y,z)==QOSG.Tile.floorTile&&!this.getEntityAt(x,y,z)};QOSG.Map.prototype.isExplored=function(x,y,z){if(this.getTile(x,y,z)!==QOSG.Tile.nullTile){return this._explored[z][x][y]}else{return false}};QOSG.Map.prototype.getEngine=function(){return this._engine};QOSG.Map.prototype.getEntityAt=function(x,y,z){return this._entities[x+","+y+","+z]};QOSG.Map.prototype.getRandomFloorPosition=function(z){var x,y;do{x=Math.floor(Math.random()*this._width);y=Math.floor(Math.random()*this._height)}while(!this.isEmptyFloor(x,y,z));return{x:x,y:y,z:z}};QOSG.Map.prototype.addEntityAtRandomPosition=function(entity,z){var position=this.getRandomFloorPosition(z);entity.setX(position.x);entity.setY(position.y);entity.setZ(position.z);this.addEntity(entity)};QOSG.Map.prototype.addEntity=function(entity){entity.setMap(this);this.updateEntityPosition(entity);if(entity.hasMixin("Actor")){this._scheduler.add(entity,true)}if(entity.hasMixin(QOSG.EntityMixins.PlayerActor)){this._player=entity}};QOSG.Map.prototype.updateEntityPosition=function(entity,oldX,oldY,oldZ){if(typeof oldX==="number"){var oldKey=oldX+","+oldY+","+oldZ;if(this._entities[oldKey]==entity){delete this._entities[oldKey]}}if(entity.getX()<0||entity.getX()>=this._width||entity.getY()<0||entity.getY()>=this._height||entity.getZ()<0||entity.getZ()>=this._depth){throw new Error("Entity's position is out of bounds.")}var key=entity.getX()+","+entity.getY()+","+entity.getZ();if(this._entities[key]){throw new Error("Tried to add an entity at an occupied position.")}this._entities[key]=entity};QOSG.Map.prototype.setupFov=function(){var map=this;for(var z=0;z<this._depth;z++){(function(){var depth=z;map._fov.push(new RTK.FOV.DiscreteShadowcasting(function(x,y){return!map.getTile(x,y,depth).isBlockingLight()},{topology:4}))})()}};QOSG.Map.prototype.getFov=function(depth){return this._fov[depth]};QOSG.Map.prototype.setExplored=function(x,y,z,state){if(this.getTile(x,y,z)!==QOSG.Tile.nullTile){this._explored[z][x][y]=state}};QOSG.Map.Cave=function(tiles,player){QOSG.Map.call(this,tiles);this.addEntityAtRandomPosition(player,0);};QOSG.Map.Cave.extend(QOSG.Map);QOSG.Builder=function(width,height,depth){this._width=width;this._height=height;this._depth=depth;this._tiles=new Array(depth);this._regions=new Array(depth);for(var z=0;z<depth;z++){this._tiles[z]=this._generateLevel()}};QOSG.Builder.prototype.getTiles=function(){return this._tiles};QOSG.Builder.prototype.getDepth=function(){return this._depth};QOSG.Builder.prototype.getWidth=function(){return this._width};QOSG.Builder.prototype.getHeight=function(){return this._height};QOSG.Builder.prototype._generateLevel=function(){var map=new Array(this._width);for(var w=0;w<this._width;w++){map[w]=new Array(this._height)}var generator=new RTK.Map.Cellular(this._width,this._height);generator.randomize(0.5);var totalIterations=3;for(var i=0;i<totalIterations-1;i++){generator.create()}generator.create(function(x,y,v){if(v===1){map[x][y]=QOSG.Tile.floorTile}else{map[x][y]=QOSG.Tile.wallTile}});return map};QOSG.Builder.prototype._canFillRegion=function(x,y,z){if(x<0||y<0||z<0||x>=this._width||y>=this._height||z>=this._depth){return false}if(this._regions[z][x][y]!=0){return false}return this._tiles[z][x][y].isWalkable()};QOSG.Builder.prototype._fillRegion=function(region,x,y,z){var tilesFilled=1;var tiles=[{x:x,y:y}];var tile;var neighbors;this._regions[z][x][y]=region;while(tiles.length>0){tile=tiles.pop();neighbors=QOSG.getNeighborPositions(tile.x,tile.y);while(neighbors.length>0){tile=neighbors.pop();if(this._canFillRegion(tile.x,tile.y,z)){this._regions[z][tile.x][tile.y]=region;tiles.push(tile);tilesFilled++}}}return tilesFilled};QOSG.Builder.prototype._removeRegion=function(region,z){for(var x=0;x<this._width;x++){for(var y=0;y<this._height;y++){if(this._regions[z][x][y]==region){this._regions[z][x][y]=0;this._tiles[z][x][y]=QOSG.Tile.wallTile}}}};QOSG.Builder.prototype._setupRegions=function(z){var region=1;var tilesFilled;for(var x=0;x<this._width;x++){for(var y=0;y<this._height;y++){if(this._canFillRegion(x,y,z)){tilesFilled=this._fillRegion(region,x,y,z);if(tilesFilled<=20){this._removeRegion(region,z)}else{region++}}}}};QOSG.Builder.prototype._findRegionOverlaps=function(z,r1,r2){var matches=[];for(var x=0;x<this._width;x++){for(var y=0;y<this._height;y++){if(this._tiles[z][x][y]==QOSG.Tile.floorTile&&this._tiles[z+1][x][y]==QOSG.Tile.floorTile&&this._regions[z][x][y]==r1&&this._regions[z+1][x][y]==r2){matches.push({x:x,y:y})}}}return matches.randomize()};QOSG.Builder.prototype._connectRegions=function(z,r1,r2){var overlap=this._findRegionOverlaps(z,r1,r2);if(overlap.length==0){return false}var point=overlap[0];this._tiles[z][point.x][point.y]=QOSG.Tile.stairsDownTile;this._tiles[z+1][point.x][point.y]=QOSG.Tile.stairsUpTile;return true};QOSG.Builder.prototype._connectAllRegions=function(){for(var z=0;z<this._depth-1;z++){var connected={};var key;for(var x=0;x<this._width;x++){for(var y=0;y<this._height;y++){key=this._regions[z][x][y]+","+this._regions[z+1][x][y];if(this._tiles[z][x][y]==QOSG.Tile.floorTile&&this._tiles[z+1][x][y]==QOSG.Tile.floorTile&&!connected[key]){this._connectRegions(z,this._regions[z][x][y],this._regions[z+1][x][y]);connected[key]=true}}}}};QOSG.EntityMixins={};QOSG.EntityMixins.PlayerActor={name:"PlayerActor",groupName:"Actor",act:function act(){if(this._acting){return}this._acting=true;if(!this.isAlive()){QOSG.Screen.playScreen.setGameEnded(true);QOSG.sendMessage(this,"Press [Enter] to continue!")}QOSG.refresh();this.getMap().getEngine().lock();this._acting=false}};QOSG.EntityMixins.Sight={name: 'Sight',groupName: 'Sight',init: function(template) {this._sightRadius = template['sightRadius'] || 5;},getSightRadius: function() {return this._sightRadius;},increaseSightRadius: function(value) {value = value || 1;this._sightRadius += value;},canSee: function(entity) {if (!entity || this._map !== entity.getMap() || this._z !== entity.getZ()) {return false;}var otherX = entity.getX();var otherY = entity.getY();if((otherX-this._x)*(otherX-this._x)+(otherY-this._y)*(otherY-this._y)>this._sightRadius*this._sightRadius){return false}var found=false;this.getMap().getFov(this.getZ()).compute(this.getX(),this.getY(),this.getSightRadius(),function(x,y,radius,visibility){if(x===otherX&&y===otherY){found=true}});return found}};QOSG.Glyph=function(properties){properties=properties||{};this._char=properties["character"]||" ";this._foreground=properties["foreground"]||"white";this._background=properties["background"]||"black"};QOSG.Glyph.prototype.getChar=function(){return this._char};QOSG.Glyph.prototype.getBackground=function(){return this._background};QOSG.Glyph.prototype.getForeground=function(){return this._foreground};QOSG.Glyph.prototype.getRepresentation=function(){return"%c{"+this._foreground+"}%b{"+this._background+"}"+this._char+"%c{white}%b{black}"};QOSG.DynamicGlyph=function(properties){properties=properties||{};QOSG.Glyph.call(this,properties);this._name=properties["name"]||"";this._attachedMixins={};this._attachedMixinGroups={};this._listeners={};var mixins=properties["mixins"]||[];for(var i=0;i<mixins.length;i++){console.log('var key in mixins, ', mixins[i]);for(var key in mixins[i]){if(key!="init"&&key!="name"&&key!="listeners"&&!this.hasOwnProperty(key)){this[key]=mixins[i][key]}}this._attachedMixins[mixins[i].name]=true;if(mixins[i].groupName){this._attachedMixinGroups[mixins[i].groupName]=true}if(mixins[i].listeners){for(var key in mixins[i].listeners){if(!this._listeners[key]){this._listeners[key]=[]}this._listeners[key].push(mixins[i].listeners[key])}}if(mixins[i].init){mixins[i].init.call(this,properties)}}};QOSG.DynamicGlyph.extend(QOSG.Glyph);QOSG.DynamicGlyph.prototype.hasMixin=function(obj){if(_typeof(obj)==="object"){return this._attachedMixins[obj.name]}else{return this._attachedMixins[obj]||this._attachedMixinGroups[obj]}};QOSG.DynamicGlyph.prototype.setName=function(name){this._name=name};QOSG.DynamicGlyph.prototype.getName=function(){return this._name};QOSG.DynamicGlyph.prototype.describe=function(){return this._name};QOSG.DynamicGlyph.prototype.describeA=function(capitalize){var prefixes=capitalize?["A","An"]:["a","an"];var string=this.describe();var firstLetter=string.charAt(0).toLowerCase();var prefix="aeiou".indexOf(firstLetter)>=0?1:0;return prefixes[prefix]+" "+string};QOSG.DynamicGlyph.prototype.describeThe=function(capitalize){var prefix=capitalize?"The":"the";return prefix+" "+this.describe()};QOSG.DynamicGlyph.prototype.raiseEvent=function(event){if(!this._listeners[event]){return}var args=Array.prototype.slice.call(arguments,1);var results=[];for(var i=0;i<this._listeners[event].length;i++){results.push(this._listeners[event][i].apply(this,args))}return results};QOSG.DynamicGlyph.prototype.details=function(){var details=[];var detailGroups=this.raiseEvent("details");if(detailGroups){for(var i=0,l=detailGroups.length;i<l;i++){if(detailGroups[i]){for(var j=0;j<detailGroups[i].length;j++){details.push(detailGroups[i][j].key+": "+detailGroups[i][j].value)}}}}return details.join(", ")};QOSG.PlayerTemplate={name:"human (you)",character:"@",foreground:"white",maxHp:40,attackValue:10,sightRadius:6,inventorySlots:22,mixins:[QOSG.EntityMixins.PlayerActor,QOSG.EntityMixins.Sight]};QOSG.Tile=function(properties){properties=properties||{};QOSG.Glyph.call(this,properties);this._walkable=properties["walkable"]||false;this._diggable=properties["diggable"]||false;this._blocksLight=properties["blocksLight"]!==undefined?properties["blocksLight"]:true;this._description=properties["description"]||""};QOSG.Tile.extend(QOSG.Glyph);QOSG.Tile.prototype.isWalkable=function(){return this._walkable};QOSG.Tile.prototype.isDiggable=function(){return this._diggable};QOSG.Tile.prototype.isBlockingLight=function(){return this._blocksLight};QOSG.Tile.nullTile=new QOSG.Tile({description:"(unknown)"});QOSG.Tile.floorTile=new QOSG.Tile({character:".",walkable:true,blocksLight:false,description:"A cave floor"});QOSG.Tile.wallTile=new QOSG.Tile({character:"#",foreground:"goldenrod",diggable:true,description:"A cave wall"});QOSG.Tile.stairsUpTile=new QOSG.Tile({character:"<",foreground:"white",walkable:true,blocksLight:false,description:"A rock staircase leading upwards"});QOSG.Tile.stairsDownTile=new QOSG.Tile({character:">",foreground:"white",walkable:true,blocksLight:false,description:"A rock staircase leading downwards"});QOSG.getNeighborPositions=function(x,y){var tiles=[];for(var dX=-10;dX<2;dX++){for(var dY=-10;dY<2;dY++){if(dX==0&&dY==0){continue}tiles.push({x:x+dX,y:y+dY})}}return tiles.randomize()};QOSG.Entity=function(properties){properties=properties||{};QOSG.DynamicGlyph.call(this,properties);this._x=properties["x"]||0;this._y=properties["y"]||0;this._z=properties["z"]||0;this._map=null;this._alive=true;this._speed=properties["speed"]||1000};QOSG.Entity.extend(QOSG.DynamicGlyph);QOSG.Entity.prototype.setX=function(x){this._x=x};QOSG.Entity.prototype.setY=function(y){this._y=y};QOSG.Entity.prototype.setZ=function(z){this._z=z};QOSG.Entity.prototype.setMap=function(map){this._map=map};QOSG.Entity.prototype.setSpeed=function(speed){this._speed=speed};QOSG.Entity.prototype.setPosition=function(x,y,z){var oldX=this._x;var oldY=this._y;var oldZ=this._z;this._x=x;this._y=y;this._z=z;if(this._map){this._map.updateEntityPosition(this,oldX,oldY,oldZ)}};QOSG.Entity.prototype.getX=function(){return this._x};QOSG.Entity.prototype.getY=function(){return this._y};QOSG.Entity.prototype.getZ=function(){return this._z};QOSG.Entity.prototype.getMap=function(){return this._map};QOSG.Entity.prototype.getSpeed=function(){return this._speed};QOSG.Entity.prototype.tryMove=function(x,y,z,map){var map=this.getMap();var tile=map.getTile(x,y,this.getZ());var target=map.getEntityAt(x,y,this.getZ());if(z<this.getZ()){if(tile!=QOSG.Tile.stairsUpTile){QOSG.sendMessage(this,"You can't go up here!")}else{QOSG.sendMessage(this,"You ascend to level %d!",[z+1]);this.setPosition(x,y,z)}}else if(z>this.getZ()){this.setPosition(x,y,z);QOSG.sendMessage(this,"You descend to level %d!",[z+1])}else if(target){if(this.hasMixin("Attacker")&&(this.hasMixin(QOSG.EntityMixins.PlayerActor)||target.hasMixin(QOSG.EntityMixins.PlayerActor))){this.attack(target);return true}return false}else if(tile.isWalkable()){this.setPosition(x,y,z);return true}else if(tile.isDiggable()){if(this.hasMixin(QOSG.EntityMixins.PlayerActor)){map.dig(x,y,z);return true}return false}return false};QOSG.Entity.prototype.isAlive=function(){return this._alive};QOSG.Entity.prototype.kill=function(message){if(!this._alive){return}this._alive=false;if(message){QOSG.sendMessage(this,message)}else{QOSG.sendMessage(this,"You have died!")}if(this.hasMixin(QOSG.EntityMixins.PlayerActor)){this.act()}else{this.getMap().removeEntity(this)}};QOSG.Entity.prototype.switchMap=function(newMap){if(newMap===this.getMap()){return}this.getMap().removeEntity(this);this._x=0;this._y=0;this._z=0;newMap.addEntity(this)};QOSG.Screen={};QOSG.Screen.startScreen={enter:function enter(){console.log("Entered start screen.")},exit:function exit(){console.log("Exited start screen.")},render:function render(display){display.drawText(1,1,"%c{yellow}Javasc Roguelike");display.drawText(1,2,"Press [Enter] to start!")}};QOSG.Screen.playScreen={_player:null,_gameEnded:false,_subScreen:null,enter:function enter(){var width=100;var height=48;var depth=6;this._player=new QOSG.Entity(QOSG.PlayerTemplate);console.log('this._player obj', this._player);var tiles=new QOSG.Builder(width,height,depth).getTiles();var map=new QOSG.Map.Cave(tiles,this._player);map.getEngine().start();},exit:function exit(){console.log("Exited play screen.")},render:function render(display){console.log('targetbasedscreen actually render(display)');this.renderTiles(display)},getScreenOffsets:function getScreenOffsets(){var topLeftX=Math.max(0,this._player.getX()-QOSG.getScreenWidth()/2);topLeftX=Math.min(topLeftX,this._player.getMap().getWidth()-QOSG.getScreenWidth());var topLeftY=Math.max(0,this._player.getY()-QOSG.getScreenHeight()/2);topLeftY=Math.min(topLeftY,this._player.getMap().getHeight()-QOSG.getScreenHeight());return{x:topLeftX,y:topLeftY}},renderTiles:function renderTiles(display){var map=this._player.getMap();var screenWidth=QOSG.getScreenWidth();var screenHeight=QOSG.getScreenHeight();var offsets=this.getScreenOffsets();var topLeftX=offsets.x;var topLeftY=offsets.y;var map=this._player.getMap();var currentDepth=this._player.getZ();var visibleCells = {};map.getFov(currentDepth).compute(this._player.getX(),this._player.getY(),this._player.getSightRadius(),function(x,y,radius,visibility){visibleCells[x+","+y]=true;map.setExplored(x,y,currentDepth,true)});for(var x=topLeftX;x<topLeftX+screenWidth;x++){for(var y=topLeftY;y<topLeftY+screenHeight;y++){if(map.isExplored(x,y,currentDepth)){var glyph=map.getTile(x,y,currentDepth);var foreground=glyph.getForeground();if(visibleCells[x+","+y]){if(map.getEntityAt(x,y,currentDepth)){glyph=map.getEntityAt(x,y,currentDepth)}foreground=glyph.getForeground()}else{foreground="darkGray"}display.draw(x-topLeftX,y-topLeftY,glyph.getChar(),foreground,glyph.getBackground())}}}}};QOSG.Screen.TargetBasedScreen=function(template){template=template||{};this._isAcceptableFunction=template["okFunction"]||function(x,y){return false};this._captionFunction=template["captionFunction"]||function(x,y){return""}};QOSG.Screen.TargetBasedScreen.prototype.setup=function(player,startX,startY,offsetX,offsetY){this._player=player;this._startX=startX-offsetX;this._startY=startY-offsetY;this._cursorX=this._startX;this._cursorY=this._startY;this._offsetX=offsetX;this._offsetY=offsetY;var visibleCells={};this._player.getMap().getFov(this._player.getZ()).compute(this._player.getX(),this._player.getY(),this._player.getSightRadius(),function(x,y,radius,visibility){visibleCells[x+","+y]=true});this._visibleCells=visibleCells};QOSG.Screen.TargetBasedScreen.prototype.render=function(display){QOSG.Screen.playScreen.renderTiles.call(QOSG.Screen.playScreen,display);display.drawText(0,QOSG.getScreenHeight()-1,this._captionFunction(this._cursorX+this._offsetX,this._cursorY+this._offsetY))};QOSG.Screen.lookScreen=new QOSG.Screen.TargetBasedScreen({captionFunction:function captionFunction(x,y){var z=this._player.getZ();var map=this._player.getMap();if(map.isExplored(x,y,z)){if(this._visibleCells[x+","+y]){if(map.getEntityAt(x,y,z)){var entity=map.getEntityAt(x,y,z);return String.format("%s - %s (%s)",entity.getRepresentation(),entity.describeA(true),entity.details())}}return String.format("%s - %s",map.getTile(x,y,z).getRepresentation(),map.getTile(x,y,z).getDescription())}else{return String.format("%s - %s",QOSG.Tile.nullTile.getRepresentation(),QOSG.Tile.nullTile.getDescription())}}});

  return QOSG
}
var exportEngineObj = new RTKControl()
var exportQOSGObj = new QOSGControl(exportEngineObj)

console.log('mystic compile, ', typeof exportQOSGObj, exportQOSGObj)
console.log('mystic compile 2, ', typeof exportQOSGObj.Map, exportQOSGObj.Map)

module.exports.RTKControl = exportEngineObj
module.exports.QOSGControl = exportQOSGObj
