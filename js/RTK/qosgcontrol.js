import {findNodeHandle, Platform, NativeModules} from 'react-native'
import {enable, Image as GImage, ReactNativeBridge} from 'gcanvas.js/src/index.js'

Array.prototype.random=Array.prototype.random||function(){if(!this.length){return null}return this[Math.floor(RTK.RNG.getUniform()*this.length)]};Array.prototype.randomize=Array.prototype.randomize||function(){var result=[];var clone=this.slice();while(clone.length){var index=clone.indexOf(clone.random());result.push(clone.splice(index,1)[0])}return result};Function.prototype.extend=Function.prototype.extend||function(parent){this.prototype=Object.create(parent.prototype);this.prototype.constructor=this;return this};String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)};String.prototype.lpad=String.prototype.lpad||function(character,count){var ch=character||"0";var cnt=count||2;var s="";while(s.length<cnt-this.length){s+=ch}s=s.substring(0,cnt-this.length);return s+this};String.prototype.rpad=String.prototype.rpad||function(character,count){var ch=character||"0";var cnt=count||2;var s="";while(s.length<cnt-this.length){s+=ch}s=s.substring(0,cnt-this.length);return this+s};String.format=String.format||function(template){var map=String.format.map;var args=Array.prototype.slice.call(arguments,1);var replacer=function(match,group1,group2,index){if(template.charAt(index-1)=="%"){return match.substring(1)}if(!args.length){return match}var obj=args[0];var group=group1||group2;var parts=group.split(",");var name=parts.shift();var method=map[name.toLowerCase()];if(!method){return match}var obj=args.shift();var replaced=obj[method].apply(obj,parts);var first=name.charAt(0);if(first!=first.toLowerCase()){replaced=replaced.capitalize()}return replaced};return template.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,replacer)};String.format.map=String.format.map||{s:"toString"};String.prototype.format=String.prototype.format||function(){var args=Array.prototype.slice.call(arguments);args.unshift(this);return String.format.apply(String,args)};

var qosgcontrol = (function() {

  var RTK = {_context:{},_data:{},_dirty:false,_options:{}};RTK.Display=function(options,refName){var ref=refName;var canvas_tag=findNodeHandle(refName);var el={ref:""+canvas_tag,style:{width:options.width,height:options.height}};ref=enable(el,{bridge:ReactNativeBridge});this._context=ref.getContext("2d");this._context.canvas={width:ref.width,height:ref.height};this._backend=null;this._data={};this._dirty=false;this._options={};this.defaultOptions={width:120,height:120,transpose:false,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:false,fontFamily:"monospace",fontStyle:"",fg:"#fff",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:false,termColor:"xterm"};for(var p in options){this.defaultOptions[p]=options[p]}this.setOptions=this.setOptions.bind(this);this._tick=this._tick.bind(this);this.setOptions(this.defaultOptions);requestAnimationFrame(this._tick)};RTK.Display.prototype.getContainer=function(){return this._context};RTK.Display.prototype._tick=function(){requestAnimationFrame(this._tick);if(!this._dirty){console.log("_tick !this._dirty ");return}if(this._dirty===true){this._context.fillStyle=this._options.bg;this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height);console.log("_tick redraw cached data ",this._data);for(var id in this._data){this._draw(id,false)}}else{for(var key in this._dirty){this._draw(key,true)}}this._dirty=false};RTK.Display.prototype.setOptions=function(options){for(var p in options){this._options[p]=options[p]}if(options.width||options.height||options.fontSize||options.fontFamily||options.spacing||options.layout){if(options.layout){console.log("prequel to the most fussy compute operation of all time");this._backend=new RTK.Display.Rect(this._context)}var font=(this._options.fontStyle?this._options.fontStyle+" ":"")+this._options.fontSize+"px "+this._options.fontFamily;this._context.font=font;this._backend.compute(this._options);this._context.font=font;this._context.textAlign="center";this._context.textBaseline="middle";this._dirty=true}return this};RTK.Display.Backend=function(context){this._context=context};RTK.Display.Backend.prototype.compute=function(options){};RTK.Display.Backend.prototype.draw=function(data,clearBefore){};RTK.Display.Backend.prototype.computeSize=function(availWidth,availHeight){};RTK.Display.Backend.prototype.computeFontSize=function(availWidth,availHeight){};RTK.Display.Backend.prototype.eventToPosition=function(x,y){};RTK.Display.Rect=function(context){RTK.Display.Backend.call(this,context);this._spacingX=0;this._spacingY=0;this._canvasCache={};this._options={}};RTK.Display.Rect.extend(RTK.Display.Backend);RTK.Display.Rect.cache=false;RTK.Display.Rect.prototype.compute=function(options){this._canvasCache={};this._options=options;var charWidth=1;this._spacingX=Math.ceil(options.spacing*charWidth);this._spacingY=Math.ceil(options.spacing*options.fontSize);if(this._options.forceSquareRatio){this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)}this._context.canvas.width=options.width*this._spacingX;this._context.canvas.height=options.height*this._spacingY};RTK.Display.Rect.prototype.draw=function(data,clearBefore){if(this.constructor.cache){this._drawWithCache(data,clearBefore)}else{this._drawNoCache(data,clearBefore)}};RTK.Display.Rect.prototype._drawWithCache=function(data,clearBefore){var x=data[0];var y=data[1];var ch=data[2];var fg=data[3];var bg=data[4];var hash=""+ch+fg+bg;if(hash in this._canvasCache){var canvas=this._canvasCache[hash]}else{var b=this._options.border;var canvas=document.createElement("canvas");var ctx=canvas.getContext("2d");canvas.width=this._spacingX;canvas.height=this._spacingY;ctx.fillStyle=bg;ctx.fillRect(b,b,canvas.width-b,canvas.height-b);if(ch){ctx.fillStyle=fg;ctx.font=this._context.font;ctx.textAlign="center";ctx.textBaseline="middle";var chars=[].concat(ch);for(var i=0;i<chars.length;i++){ctx.fillText(chars[i],this._spacingX/2,Math.ceil(this._spacingY/2))}}this._canvasCache[hash]=canvas}this._context.drawImage(canvas,x*this._spacingX,y*this._spacingY)};RTK.Display.Rect.prototype._drawNoCache=function(data,clearBefore){var x=data[0];var y=data[1];var ch=data[2];var fg=data[3];var bg=data[4];if(clearBefore){var b=this._options.border;this._context.fillStyle=bg;this._context.fillRect(x*this._spacingX+b,y*this._spacingY+b,this._spacingX-b,this._spacingY-b)}if(!ch){return}this._context.fillStyle=fg;var chars=[].concat(ch);for(var i=0;i<chars.length;i++){this._context.fillText(chars[i],(x+.5)*this._spacingX,Math.ceil((y+.5)*this._spacingY))}};RTK.Map=function(width,height){this._width=width||RTK.DEFAULT_WIDTH;this._height=height||RTK.DEFAULT_HEIGHT};RTK.Map.prototype.create=function(callback){};RTK.Map.prototype._fillMap=function(value){var map=[];for(var i=0;i<this._width;i++){map.push([]);for(var j=0;j<this._height;j++){map[i].push(value)}}return map};RTK.Map.Arena=function(width,height){RTK.Map.call(this,width,height)};RTK.Map.Arena.extend(RTK.Map);RTK.Map.Arena.prototype.create=function(callback){var w=this._width-1;var h=this._height-1;for(var i=0;i<=w;i++){for(var j=0;j<=h;j++){var empty=i&&j&&i<w&&j<h;callback(i,j,empty?0:1)}}return this};

  return RTK
})


var exportObj = new qosgcontrol()

console.log('mystic compile, ', typeof exportObj, exportObj)
console.log('mystic compile 2, ', typeof exportObj.Display, exportObj.Display)

module.exports.qosgcontrol = exportObj
