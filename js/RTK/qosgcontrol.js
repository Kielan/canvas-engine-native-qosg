import {findNodeHandle, Platform, NativeModules} from 'react-native'
import {enable, Image as GImage, ReactNativeBridge} from 'gcanvas.js/src/index.js'

var RTKControl = (function() {

  Array.prototype.random=Array.prototype.random||function(){if(!this.length){return null}return this[Math.floor(RTK.RNG.getUniform()*this.length)]};Array.prototype.randomize=Array.prototype.randomize||function(){var result=[];var clone=this.slice();while(clone.length){var index=clone.indexOf(clone.random());result.push(clone.splice(index,1)[0])}return result};Function.prototype.extend=Function.prototype.extend||function(parent){this.prototype=Object.create(parent.prototype);this.prototype.constructor=this;return this};String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)};String.prototype.lpad=String.prototype.lpad||function(character,count){var ch=character||"0";var cnt=count||2;var s="";while(s.length<cnt-this.length){s+=ch}s=s.substring(0,cnt-this.length);return s+this};String.prototype.rpad=String.prototype.rpad||function(character,count){var ch=character||"0";var cnt=count||2;var s="";while(s.length<cnt-this.length){s+=ch}s=s.substring(0,cnt-this.length);return this+s};String.format=String.format||function(template){var map=String.format.map;var args=Array.prototype.slice.call(arguments,1);var replacer=function(match,group1,group2,index){if(template.charAt(index-1)=="%"){return match.substring(1)}if(!args.length){return match}var obj=args[0];var group=group1||group2;var parts=group.split(",");var name=parts.shift();var method=map[name.toLowerCase()];if(!method){return match}var obj=args.shift();var replaced=obj[method].apply(obj,parts);var first=name.charAt(0);if(first!=first.toLowerCase()){replaced=replaced.capitalize()}return replaced};return template.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,replacer)};String.format.map=String.format.map||{s:"toString"};String.prototype.format=String.prototype.format||function(){var args=Array.prototype.slice.call(arguments);args.unshift(this);return String.format.apply(String,args)};


  var RTK={_context:{},_data:{},_dirty:false,_options:{},DIRS:{4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]}};RTK.Display=function(options,refName){var ref=refName;var canvas_tag=findNodeHandle(refName);var el={ref:""+canvas_tag,style:{width:options.width,height:options.height}};ref=enable(el,{bridge:ReactNativeBridge});this._context=ref.getContext("2d");this._context.canvas={width:ref.width,height:ref.height};this._backend=null;this._data={};this._dirty=false;this._options={};this.defaultOptions={width:400,height:400,transpose:false,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:false,fontFamily:"monospace",fontStyle:"",fg:"#fff",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:false,termColor:"xterm"};this.defaultOptions = {...this.defaultOptions, ...options };this.setOptions=this.setOptions.bind(this);this._tick=this._tick.bind(this);this.setOptions(this.defaultOptions);requestAnimationFrame(this._tick)};RTK.Display.prototype.getContainer=function(){return this._context};RTK.Display.prototype._tick=function(){requestAnimationFrame(this._tick);if(!this._dirty){console.log("_tick !this._dirty ");return}if(this._dirty===true){this._context.fillStyle=this._options.bg;console.log('this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height)', this._context.canvas);this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height);console.log("_tick redraw cached data ",this._data);for(var id in this._data){this._draw(id,false)}}else{for(var key in this._dirty){this._draw(key,true)}}this._dirty=false};RTK.Display.prototype.setOptions=function(options){for(var p in options){this._options[p]=options[p]}if(options.width||options.height||options.fontSize||options.fontFamily||options.spacing||options.layout){if(options.layout){console.log("prequel to the most fussy compute operation of all time");this._backend=new RTK.Display.Rect(this._context)}var font=(this._options.fontStyle?this._options.fontStyle+" ":"")+this._options.fontSize+"px "+this._options.fontFamily;this._context.font=font;this._backend.compute(this._options);this._context.font=font;this._context.textAlign="center";this._context.textBaseline="middle";this._dirty=true}return this};RTK.Display.Backend=function(context){this._context=context};RTK.Display.Backend.prototype.compute=function(options){};RTK.Display.Backend.prototype.draw=function(data,clearBefore){};RTK.Display.Backend.prototype.computeSize=function(availWidth,availHeight){};RTK.Display.Backend.prototype.computeFontSize=function(availWidth,availHeight){};RTK.Display.Backend.prototype.eventToPosition=function(x,y){};RTK.Display.Rect=function(context){RTK.Display.Backend.call(this,context);this._spacingX=0;this._spacingY=0;this._canvasCache={};this._options={}};RTK.Display.Rect.extend(RTK.Display.Backend);RTK.Display.Rect.cache=false;RTK.Display.Rect.prototype.compute=function(options){this._canvasCache={};this._options=options;var charWidth=1;this._spacingX=Math.ceil(options.spacing*charWidth);this._spacingY=Math.ceil(options.spacing*options.fontSize);if(this._options.forceSquareRatio){this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)}this._context.canvas.width=options.width*this._spacingX;this._context.canvas.height=options.height*this._spacingY};RTK.Display.Rect.prototype.draw=function(data,clearBefore){if(this.constructor.cache){this._drawWithCache(data,clearBefore)}else{this._drawNoCache(data,clearBefore)}};RTK.Display.Rect.prototype._drawWithCache=function(data,clearBefore){var x=data[0];var y=data[1];var ch=data[2];var fg=data[3];var bg=data[4];var hash=""+ch+fg+bg;if(hash in this._canvasCache){var canvas=this._canvasCache[hash]}else{var b=this._options.border;var canvas=document.createElement("canvas");var ctx=canvas.getContext("2d");canvas.width=this._spacingX;canvas.height=this._spacingY;ctx.fillStyle=bg;ctx.fillRect(b,b,canvas.width-b,canvas.height-b);if(ch){ctx.fillStyle=fg;ctx.font=this._context.font;ctx.textAlign="center";ctx.textBaseline="middle";var chars=[].concat(ch);for(var i=0;i<chars.length;i++){ctx.fillText(chars[i],this._spacingX/2,Math.ceil(this._spacingY/2))}}this._canvasCache[hash]=canvas}this._context.drawImage(canvas,x*this._spacingX,y*this._spacingY)};RTK.Display.Rect.prototype._drawNoCache=function(data,clearBefore){var x=data[0];var y=data[1];var ch=data[2];var fg=data[3];var bg=data[4];if(clearBefore){var b=this._options.border;this._context.fillStyle=bg;this._context.fillRect(x*this._spacingX+b,y*this._spacingY+b,this._spacingX-b,this._spacingY-b)}if(!ch){return}this._context.fillStyle=fg;var chars=[].concat(ch);for(var i=0;i<chars.length;i++){this._context.fillText(chars[i],(x+.5)*this._spacingX,Math.ceil((y+.5)*this._spacingY))}};RTK.Map=function(width,height){this._width=width||RTK.DEFAULT_WIDTH;this._height=height||RTK.DEFAULT_HEIGHT};RTK.Map.prototype.create=function(callback){};RTK.Map.prototype._fillMap=function(value){var map=[];for(var i=0;i<this._width;i++){map.push([]);for(var j=0;j<this._height;j++){map[i].push(value)}}return map};RTK.Map.Arena=function(width,height){RTK.Map.call(this,width,height)};RTK.Map.Arena.extend(RTK.Map);RTK.Map.Arena.prototype.create=function(callback){var w=this._width-1;var h=this._height-1;for(var i=0;i<=w;i++){for(var j=0;j<=h;j++){var empty=i&&j&&i<w&&j<h;callback(i,j,empty?0:1)}};console.log('RTK.Map.Arena.prototype.create', this); return this};RTK.EventQueue=function(){this._time=0;this._events=[];this._eventTimes=[]};RTK.EventQueue.prototype.getTime=function(){return this._time};RTK.EventQueue.prototype.clear=function(){this._events=[];this._eventTimes=[];return this};RTK.EventQueue.prototype.add=function(event,time){var index=this._events.length;for(var i=0;i<this._eventTimes.length;i++){if(this._eventTimes[i]>time){index=i;break}}this._events.splice(index,0,event);this._eventTimes.splice(index,0,time)};RTK.EventQueue.prototype.get=function(){if(!this._events.length){return null}var time=this._eventTimes.splice(0,1)[0];if(time>0){this._time+=time;for(var i=0;i<this._eventTimes.length;i++){this._eventTimes[i]-=time}}return this._events.splice(0,1)[0]};RTK.EventQueue.prototype.getEventTime=function(event){var index=this._events.indexOf(event);if(index==-1){return undefined}return this._eventTimes[index]};RTK.EventQueue.prototype.remove=function(event){var index=this._events.indexOf(event);if(index==-1){return false}this._remove(index);return true};RTK.EventQueue.prototype._remove=function(index){this._events.splice(index,1);this._eventTimes.splice(index,1)};RTK.Scheduler=function(){this._queue=new RTK.EventQueue;this._repeat=[];this._current=null};RTK.Scheduler.prototype.getTime=function(){return this._queue.getTime()};RTK.Scheduler.prototype.add=function(item,repeat){if(repeat){this._repeat.push(item)}return this};RTK.Scheduler.prototype.getTimeOf=function(item){return this._queue.getEventTime(item)};RTK.Scheduler.prototype.clear=function(){this._queue.clear();this._repeat=[];this._current=null;return this};RTK.Scheduler.prototype.remove=function(item){var result=this._queue.remove(item);var index=this._repeat.indexOf(item);if(index!=-1){this._repeat.splice(index,1)}if(this._current==item){this._current=null}return result};RTK.Scheduler.prototype.next=function(){this._current=this._queue.get();return this._current};RTK.Scheduler.Speed=function(){RTK.Scheduler.call(this)};RTK.Scheduler.Speed.extend(RTK.Scheduler);RTK.Scheduler.Speed.prototype.add=function(item,repeat,time){this._queue.add(item,time!==undefined?time:1/item.getSpeed());return RTK.Scheduler.prototype.add.call(this,item,repeat)};RTK.Scheduler.Speed.prototype.next=function(){if(this._current&&this._repeat.indexOf(this._current)!=-1){this._queue.add(this._current,1/this._current.getSpeed())}return RTK.Scheduler.prototype.next.call(this)};RTK.Map.Cellular=function(width,height,options){RTK.Map.call(this,width,height);this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8};this.setOptions(options);this._dirs=RTK.DIRS[this._options.topology];this._map=this._fillMap(0)};RTK.Map.Cellular.extend(RTK.Map);RTK.Map.Cellular.prototype.randomize=function(probability){for(var i=0;i<this._width;i++){for(var j=0;j<this._height;j++){this._map[i][j]=RTK.RNG.getUniform()<probability?1:0}}return this};RTK.Map.Cellular.prototype.setOptions=function(options){for(var p in options){this._options[p]=options[p]}};RTK.Map.Cellular.prototype.set=function(x,y,value){this._map[x][y]=value};RTK.Map.Cellular.prototype.create=function(callback){var newMap=this._fillMap(0);var born=this._options.born;var survive=this._options.survive;for(var j=0;j<this._height;j++){var widthStep=1;var widthStart=0;if(this._options.topology==6){widthStep=2;widthStart=j%2}for(var i=widthStart;i<this._width;i+=widthStep){var cur=this._map[i][j];var ncount=this._getNeighbors(i,j);if(cur&&survive.indexOf(ncount)!=-1){newMap[i][j]=1}else if(!cur&&born.indexOf(ncount)!=-1){newMap[i][j]=1}}}this._map=newMap;callback&&this._serviceCallback(callback)};RTK.Map.Cellular.prototype._serviceCallback=function(callback){for(var j=0;j<this._height;j++){var widthStep=1;var widthStart=0;if(this._options.topology==6){widthStep=2;widthStart=j%2}for(var i=widthStart;i<this._width;i+=widthStep){callback(i,j,this._map[i][j])}}};RTK.Map.Cellular.prototype._getNeighbors=function(cx,cy){var result=0;for(var i=0;i<this._dirs.length;i++){var dir=this._dirs[i];var x=cx+dir[0];var y=cy+dir[1];if(x<0||x>=this._width||y<0||y>=this._height){continue}result+=this._map[x][y]==1?1:0}return result};RTK.Map.Cellular.prototype.connect=function(callback,value,connectionCallback){if(!value)value=0;var allFreeSpace=[];var notConnected={};var widthStep=1;var widthStarts=[0,0];if(this._options.topology==6){widthStep=2;widthStarts=[0,1]}for(var y=0;y<this._height;y++){for(var x=widthStarts[y%2];x<this._width;x+=widthStep){if(this._freeSpace(x,y,value)){var p=[x,y];notConnected[this._pointKey(p)]=p;allFreeSpace.push([x,y])}}}var start=allFreeSpace[RTK.RNG.getUniformInt(0,allFreeSpace.length-1)];var key=this._pointKey(start);var connected={};connected[key]=start;delete notConnected[key];this._findConnected(connected,notConnected,[start],false,value);while(Object.keys(notConnected).length>0){var p=this._getFromTo(connected,notConnected);var from=p[0];var to=p[1];var local={};local[this._pointKey(from)]=from;this._findConnected(local,notConnected,[from],true,value);var tunnelFn=this._options.topology==6?this._tunnelToConnected6:this._tunnelToConnected;tunnelFn.call(this,to,from,connected,notConnected,value,connectionCallback);for(var k in local){var pp=local[k];this._map[pp[0]][pp[1]]=value;connected[k]=pp;delete notConnected[k]}}callback&&this._serviceCallback(callback)};RTK.Map.Cellular.prototype._getFromTo=function(connected,notConnected){var from,to,d;var connectedKeys=Object.keys(connected);var notConnectedKeys=Object.keys(notConnected);for(var i=0;i<5;i++){if(connectedKeys.length<notConnectedKeys.length){var keys=connectedKeys;to=connected[keys[RTK.RNG.getUniformInt(0,keys.length-1)]];from=this._getClosest(to,notConnected)}else{var keys=notConnectedKeys;from=notConnected[keys[RTK.RNG.getUniformInt(0,keys.length-1)]];to=this._getClosest(from,connected)}d=(from[0]-to[0])*(from[0]-to[0])+(from[1]-to[1])*(from[1]-to[1]);if(d<64){break}}return[from,to]};RTK.Map.Cellular.prototype._getClosest=function(point,space){var minPoint=null;var minDist=null;for(k in space){var p=space[k];var d=(p[0]-point[0])*(p[0]-point[0])+(p[1]-point[1])*(p[1]-point[1]);if(minDist==null||d<minDist){minDist=d;minPoint=p}}return minPoint};RTK.Map.Cellular.prototype._findConnected=function(connected,notConnected,stack,keepNotConnected,value){while(stack.length>0){var p=stack.splice(0,1)[0];var tests;if(this._options.topology==6){tests=[[p[0]+2,p[1]],[p[0]+1,p[1]-1],[p[0]-1,p[1]-1],[p[0]-2,p[1]],[p[0]-1,p[1]+1],[p[0]+1,p[1]+1]]}else{tests=[[p[0]+1,p[1]],[p[0]-1,p[1]],[p[0],p[1]+1],[p[0],p[1]-1]]}for(var i=0;i<tests.length;i++){var key=this._pointKey(tests[i]);if(connected[key]==null&&this._freeSpace(tests[i][0],tests[i][1],value)){connected[key]=tests[i];if(!keepNotConnected){delete notConnected[key]}stack.push(tests[i])}}}};RTK.Map.Cellular.prototype._tunnelToConnected=function(to,from,connected,notConnected,value,connectionCallback){var key=this._pointKey(from);var a,b;if(from[0]<to[0]){a=from;b=to}else{a=to;b=from}for(var xx=a[0];xx<=b[0];xx++){this._map[xx][a[1]]=value;var p=[xx,a[1]];var pkey=this._pointKey(p);connected[pkey]=p;delete notConnected[pkey]}if(connectionCallback&&a[0]<b[0]){connectionCallback(a,[b[0],a[1]])}var x=b[0];if(from[1]<to[1]){a=from;b=to}else{a=to;b=from}for(var yy=a[1];yy<b[1];yy++){this._map[x][yy]=value;var p=[x,yy];var pkey=this._pointKey(p);connected[pkey]=p;delete notConnected[pkey]}if(connectionCallback&&a[1]<b[1]){connectionCallback([b[0],a[1]],[b[0],b[1]])}};RTK.Map.Cellular.prototype._tunnelToConnected6=function(to,from,connected,notConnected,value,connectionCallback){var a,b;if(from[0]<to[0]){a=from;b=to}else{a=to;b=from}var xx=a[0];var yy=a[1];while(!(xx==b[0]&&yy==b[1])){var stepWidth=2;if(yy<b[1]){yy++;stepWidth=1}else if(yy>b[1]){yy--;stepWidth=1}if(xx<b[0]){xx+=stepWidth}else if(xx>b[0]){xx-=stepWidth}else if(b[1]%2){xx-=stepWidth}else{xx+=stepWidth}this._map[xx][yy]=value;var p=[xx,yy];var pkey=this._pointKey(p);connected[pkey]=p;delete notConnected[pkey]}if(connectionCallback){connectionCallback(from,to)}};RTK.Map.Cellular.prototype._freeSpace=function(x,y,value){return x>=0&&x<this._width&&y>=0&&y<this._height&&this._map[x][y]==value};RTK.Map.Cellular.prototype._pointKey=function(p){return p[0]+"."+p[1]};RTK.RNG={getSeed:function(){return this._seed},setSeed:function(seed){seed=seed<1?1/seed:seed;this._seed=seed;this._s0=(seed>>>0)*this._frac;seed=seed*69069+1>>>0;this._s1=seed*this._frac;seed=seed*69069+1>>>0;this._s2=seed*this._frac;this._c=1;return this},getUniform:function(){var t=2091639*this._s0+this._c*this._frac;this._s0=this._s1;this._s1=this._s2;this._c=t|0;this._s2=t-this._c;return this._s2},getUniformInt:function(lowerBound,upperBound){var max=Math.max(lowerBound,upperBound);var min=Math.min(lowerBound,upperBound);return Math.floor(this.getUniform()*(max-min+1))+min},getNormal:function(mean,stddev){do{var u=2*this.getUniform()-1;var v=2*this.getUniform()-1;var r=u*u+v*v}while(r>1||r==0);var gauss=u*Math.sqrt(-2*Math.log(r)/r);return(mean||0)+gauss*(stddev||1)},getPercentage:function(){return 1+Math.floor(this.getUniform()*100)},getWeightedValue:function(data){var total=0;for(var id in data){total+=data[id]}var random=this.getUniform()*total;var part=0;for(var id in data){part+=data[id];if(random<part){return id}}return id},getState:function(){return[this._s0,this._s1,this._s2,this._c]},setState:function(state){this._s0=state[0];this._s1=state[1];this._s2=state[2];this._c=state[3];return this},clone:function(){var clone=Object.create(this);clone.setState(this.getState());return clone},_s0:0,_s1:0,_s2:0,_c:0,_frac:2.3283064365386963e-10};RTK.RNG.setSeed(Date.now());

  return RTK
})

var QOSGControl = function(RTK) {
  var QOSG={_display:null,_currentScreen:null,_screenWidth:80,_screenHeight:24,init:function(){this._display=new RTK.Display({width:this._screenWidth,height:this._screenHeight+1});var game=this}};QOSG.Builder=function(width,height,depth){this._width=width;this._height=height;this._depth=depth;this._tiles=new Array(depth);this._regions=new Array(depth);for(var z=0;z<depth;z++){this._tiles[z]=this._generateLevel();this._regions[z]=new Array(width);for(var x=0;x<width;x++){this._regions[z][x]=new Array(height);for(var y=0;y<height;y++){this._regions[z][x][y]=0}}}for(var z=0;z<this._depth;z++){this._setupRegions(z)}this._connectAllRegions()};QOSG.Builder.prototype.getTiles=function(){return this._tiles};QOSG.Builder.prototype.getDepth=function(){return this._depth};QOSG.Builder.prototype.getWidth=function(){return this._width};QOSG.Builder.prototype.getHeight=function(){return this._height};QOSG.Builder.prototype._generateLevel=function(){var map=new Array(this._width);for(var w=0;w<this._width;w++){map[w]=new Array(this._height)}var generator=new RTK.Map.Cellular(this._width,this._height);generator.randomize(.5);var totalIterations=3;for(var i=0;i<totalIterations-1;i++){generator.create()}generator.create(function(x,y,v){if(v===1){map[x][y]=QOSG.Tile.floorTile}else{map[x][y]=QOSG.Tile.wallTile}});return map};QOSG.Builder.prototype._canFillRegion=function(x,y,z){if(x<0||y<0||z<0||x>=this._width||y>=this._height||z>=this._depth){return false}if(this._regions[z][x][y]!=0){return false}return this._tiles[z][x][y].isWalkable()};QOSG.Builder.prototype._fillRegion=function(region,x,y,z){var tilesFilled=1;var tiles=[{x:x,y:y}];var tile;var neighbors;this._regions[z][x][y]=region;while(tiles.length>0){tile=tiles.pop();neighbors=QOSG.getNeighborPositions(tile.x,tile.y);while(neighbors.length>0){tile=neighbors.pop();if(this._canFillRegion(tile.x,tile.y,z)){this._regions[z][tile.x][tile.y]=region;tiles.push(tile);tilesFilled++}}}return tilesFilled};QOSG.Builder.prototype._removeRegion=function(region,z){for(var x=0;x<this._width;x++){for(var y=0;y<this._height;y++){if(this._regions[z][x][y]==region){this._regions[z][x][y]=0;this._tiles[z][x][y]=QOSG.Tile.wallTile}}}};QOSG.Builder.prototype._setupRegions=function(z){var region=1;var tilesFilled;for(var x=0;x<this._width;x++){for(var y=0;y<this._height;y++){if(this._canFillRegion(x,y,z)){tilesFilled=this._fillRegion(region,x,y,z);if(tilesFilled<=20){this._removeRegion(region,z)}else{region++}}}}};QOSG.Builder.prototype._findRegionOverlaps=function(z,r1,r2){var matches=[];for(var x=0;x<this._width;x++){for(var y=0;y<this._height;y++){if(this._tiles[z][x][y]==QOSG.Tile.floorTile&&this._tiles[z+1][x][y]==QOSG.Tile.floorTile&&this._regions[z][x][y]==r1&&this._regions[z+1][x][y]==r2){matches.push({x:x,y:y})}}}return matches.randomize()};QOSG.Builder.prototype._connectRegions=function(z,r1,r2){var overlap=this._findRegionOverlaps(z,r1,r2);if(overlap.length==0){return false}var point=overlap[0];this._tiles[z][point.x][point.y]=QOSG.Tile.stairsDownTile;this._tiles[z+1][point.x][point.y]=QOSG.Tile.stairsUpTile;return true};QOSG.Builder.prototype._connectAllRegions=function(){for(var z=0;z<this._depth-1;z++){var connected={};var key;for(var x=0;x<this._width;x++){for(var y=0;y<this._height;y++){key=this._regions[z][x][y]+","+this._regions[z+1][x][y];if(this._tiles[z][x][y]==QOSG.Tile.floorTile&&this._tiles[z+1][x][y]==QOSG.Tile.floorTile&&!connected[key]){this._connectRegions(z,this._regions[z][x][y],this._regions[z+1][x][y]);connected[key]=true}}}}};QOSG.Map=function(tiles){this._tiles=tiles;this._depth=tiles.length;this._width=tiles[0].length;this._height=tiles[0][0].length;this._fov=[];this.setupFov();this._entities={};this._items={};this._scheduler=new RTK.Scheduler.Speed;this._engine=new RTK.Engine(this._scheduler)};QOSG.Map.prototype.getDepth=function(){return this._depth};QOSG.Map.prototype.getWidth=function(){return this._width};QOSG.Map.prototype.getHeight=function(){return this._height};QOSG.Map.prototype.getTile=function(x,y,z){if(x<0||x>=this._width||y<0||y>=this._height||z<0||z>=this._depth){return QOSG.Tile.nullTile}else{return this._tiles[z][x][y]||QOSG.Tile.nullTile}};QOSG.Map.prototype.dig=function(x,y,z){if(this.getTile(x,y,z).isDiggable()){this._tiles[z][x][y]=QOSG.Tile.floorTile}};QOSG.Map.prototype.isEmptyFloor=function(x,y,z){return this.getTile(x,y,z)==QOSG.Tile.floorTile&&!this.getEntityAt(x,y,z)};QOSG.Glyph=function(properties){properties=properties||{};this._char=properties["character"]||" ";this._foreground=properties["foreground"]||"white";this._background=properties["background"]||"black"};QOSG.Glyph.prototype.getChar=function(){return this._char};QOSG.Glyph.prototype.getBackground=function(){return this._background};QOSG.Glyph.prototype.getForeground=function(){return this._foreground};QOSG.Glyph.prototype.getRepresentation=function(){return"%c{"+this._foreground+"}%b{"+this._background+"}"+this._char+"%c{white}%b{black}"};QOSG.Tile=function(properties){properties=properties||{};QOSG.Glyph.call(this,properties);this._walkable=properties["walkable"]||false;this._diggable=properties["diggable"]||false;this._blocksLight=properties["blocksLight"]!==undefined?properties["blocksLight"]:true;this._description=properties["description"]||""};QOSG.Tile.extend(QOSG.Glyph);QOSG.Tile.prototype.isWalkable=function(){return this._walkable};QOSG.Tile.prototype.isDiggable=function(){return this._diggable};QOSG.Tile.nullTile=new QOSG.Tile({description:"(unknown)"});QOSG.Tile.floorTile=new QOSG.Tile({character:".",walkable:true,blocksLight:false,description:"A cave floor"});QOSG.Tile.wallTile=new QOSG.Tile({character:"#",foreground:"goldenrod",diggable:true,description:"A cave wall"});QOSG.Tile.stairsUpTile=new QOSG.Tile({character:"<",foreground:"white",walkable:true,blocksLight:false,description:"A rock staircase leading upwards"});QOSG.Tile.stairsDownTile=new QOSG.Tile({character:">",foreground:"white",walkable:true,blocksLight:false,description:"A rock staircase leading downwards"});QOSG.getNeighborPositions=function(x,y){var tiles=[];for(var dX=-1;dX<2;dX++){for(var dY=-1;dY<2;dY++){if(dX==0&&dY==0){continue}tiles.push({x:x+dX,y:y+dY})}}return tiles.randomize()};QOSG.Map=function(tiles){this._tiles=tiles;this._depth=tiles.length;this._width=tiles[0].length;this._height=tiles[0][0].length;this._entities={};this._scheduler=new RTK.Scheduler.Speed;this._engine=new RTK.Engine(this._scheduler)};QOSG.Map.prototype.getDepth=function(){return this._depth};QOSG.Map.prototype.getWidth=function(){return this._width};QOSG.Map.prototype.getHeight=function(){return this._height};QOSG.Map.prototype.getTile=function(x,y,z){if(x<0||x>=this._width||y<0||y>=this._height||z<0||z>=this._depth){return QOSG.Tile.nullTile}else{return this._tiles[z][x][y]||QOSG.Tile.nullTile}};QOSG.Map.prototype.dig=function(x,y,z){if(this.getTile(x,y,z).isDiggable()){this._tiles[z][x][y]=QOSG.Tile.floorTile}};QOSG.Map.prototype.isEmptyFloor=function(x,y,z){return this.getTile(x,y,z)==QOSG.Tile.floorTile&&!this.getEntityAt(x,y,z)};QOSG.Map.prototype.getEngine=function(){return this._engine};QOSG.Map.prototype.getEntityAt=function(x,y,z){return this._entities[x+","+y+","+z]};QOSG.Map.prototype.getRandomFloorPosition=function(z){var x,y;do{x=Math.floor(Math.random()*this._width);y=Math.floor(Math.random()*this._height)}while(!this.isEmptyFloor(x,y,z));return{x:x,y:y,z:z}};QOSG.Map.Cave=function(tiles,player){QOSG.Map.call(this,tiles);var holePosition=this.getRandomFloorPosition(this._depth-1);this._tiles[this._depth-1][holePosition.x][holePosition.y]=QOSG.Tile.holeToCavernTile};QOSG.Map.Cave.extend(QOSG.Map);RTK.Engine=function(scheduler){this._scheduler=scheduler;this._lock=1};RTK.Engine.prototype.start=function(){return this.unlock()};RTK.Engine.prototype.lock=function(){this._lock++;return this};RTK.Engine.prototype.unlock=function(){if(!this._lock){throw new Error("Cannot unlock unlocked engine")}this._lock--;while(!this._lock){var actor=this._scheduler.next();if(!actor){return this.lock()}var result=actor.act();if(result&&result.then){this.lock();result.then(this.unlock.bind(this))}}return this};

  return QOSG
}
var exportEngineObj = new RTKControl()
var exportQOSGObj = new QOSGControl(exportEngineObj)

console.log('mystic compile, ', typeof exportQOSGObj, exportQOSGObj)
console.log('mystic compile 2, ', typeof exportQOSGObj.Map, exportQOSGObj.Map)

module.exports.RTKControl = exportEngineObj
module.exports.QOSGControl = exportQOSGObj
